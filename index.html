<!DOCTYPE html>
<html>
<head>
  <title>VibeFlight: Music-Reactive Drone Swarm üöÄ‚ú®</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.4/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.4/addons/p5.sound.min.js"></script>
  <style>
    html, body { margin:0; padding:0; overflow:hidden; background: #000; font-family: monospace; color: #0ff; }
    canvas { display: block; }
    #info { position: absolute; top:10px; left:10px; z-index:10; background:rgba(0,0,0,0.8); padding:15px; border-radius:10px; max-width:400px; max-height:280px; overflow:hidden; }
    button { background: linear-gradient(45deg, #f0f, #ff0); color:#000; border:none; padding:12px 20px; cursor:pointer; font-size:16px; border-radius:8px; margin:5px 0; display:block; width:100%; box-sizing:border-box; font-weight:bold; transition: all 0.3s; }
    button:hover { background: linear-gradient(45deg, #ff0, #f0f); transform: scale(1.05); box-shadow: 0 0 20px #ff0; }
    #uploadBtn { position: absolute; top:380px; left:10px; z-index:20; width:350px; background: linear-gradient(45deg, #0ff, #f0f) !important; }
    #uploadBtn:hover { box-shadow: 0 0 30px #0ff; }
    #demoBtn { position: absolute; top:320px; left:10px; z-index:20; width:350px; background: linear-gradient(45deg, #0f0, #ff0) !important; }
    #status { color: #0f0; font-size:14px; margin-top:10px; font-family: monospace; white-space: pre-line; }
    input[type=file] { display: none; } /* Hidden, triggered by label */
  </style>
</head>
<body>
  <div id="info">
    <h2>VibeFlight by C0DEXog</h2>
    <p>Click below ‚Üí Drones swarm to beats!<br>PID flight sim for LAT Aerospace.</p>
    <button onclick="toggleMic()">üé§ Toggle Mic (Speak/Clap Loud!)</button>
    <button id="demoBtn" onclick="loadDemoSong()">üéµ Demo Song (Instant Test ‚Äì No Upload)</button>
    <label for="songFile" id="uploadBtn">
      üéµ Upload Song (MP3/WAV/OGG ‚Äì Click Here!)
    </label>
    <input type="file" id="songFile" accept="audio/*" onchange="handleSong(event)">
    <div id="status">Status: Ready! Try Demo first. Console F12.</div>
    <p><a href="https://github.com/C0DEXog/VibeFlight" target="_blank" style="color:#ff0;">‚≠ê Star on GitHub!</a></p>
  </div>

  <script>
    let mic, fft, song;
    let drones = [];
    let numDrones = 35;
    let isMicOn = false;
    let statusEl = document.getElementById('status');

    // PID & Drone (bass x2 for EPIC reaction)
    class PID {
      constructor(kp=1.8, ki=0.3, kd=0.25) {
        this.kp = kp; this.ki = ki; this.kd = kd;
        this.prevError = 0; this.integral = 0;
      }
      update(target, current, dt) {
        let error = target - current;
        this.integral += error * dt;
        let derivative = (error - this.prevError) / dt;
        this.prevError = error;
        return this.kp * error + this.ki * this.integral + this.kd * derivative;
      }
    }

    class Drone {
      constructor(x, y) {
        this.pos = createVector(x, y);
        this.vel = createVector(random(-1.5,1.5), random(-1.5,1.5));
        this.acc = createVector(0, 0);
        this.angle = 0;
        this.thrust = 0;
        this.trail = [];
        this.pid = new PID();
        this.targetX = x; this.targetY = y;
      }
      update(dt, bass) {
        this.targetX += sin(frameCount * 0.025 + bass * 10) * 25;
        this.targetY += cos(frameCount * 0.02 + bass * 7) * 25;

        let errorX = this.targetX - this.pos.x;
        this.thrust = this.pid.update(this.targetX, this.pos.x, dt);
        this.thrust = constrain(this.thrust, -12, 12);

        this.angle = atan2(this.vel.y, this.vel.x) + bass;
        let force = p5.Vector.fromAngle(this.angle);
        force.mult(this.thrust * 0.025 + bass * 2.5);
        this.acc = force;
        this.vel.add(this.acc);
        this.vel.mult(0.88);
        this.pos.add(this.vel);

        this.pos.x = constrain(this.pos.x, 0, width);
        this.pos.y = constrain(this.pos.y, 0, height);

        this.trail.push(this.pos.copy());
        if (this.trail.length > 30) this.trail.shift();
      }
      draw() {
        drawingContext.shadowBlur = 35;
        drawingContext.shadowColor = `hsl(${frameCount*0.35 + bass*20 % 360}, 100%, 70%)`;
        noFill();
        stroke(0, 255, 255, 140);
        strokeWeight(5);
        beginShape();
        for (let p of this.trail) vertex(p.x, p.y);
        endShape();

        drawingContext.shadowBlur = 30;
        drawingContext.shadowColor = `hsl(${frameCount*0.6 % 360}, 100%, 60%)`;
        fill(255, 255, 100 + abs(this.thrust)*50, 240);
        noStroke();
        ellipse(this.pos.x, this.pos.y, 35 + abs(this.thrust)*2, 35 + abs(this.thrust)*2);

        fill(0, 255, 0);
        textSize(16);
        textAlign(CENTER);
        text(`${int(this.thrust*10)}`, this.pos.x, this.pos.y + 8);
      }
    }

    function setup() {
      createCanvas(windowWidth, windowHeight);
      colorMode(HSB, 360, 100, 100, 1);
      for (let i = 0; i < numDrones; i++) {
        drones.push(new Drone(random(width*0.05, width*0.95), random(height*0.05, height*0.95)));
      }
      console.log('üåü VibeFlight READY! Demo button for instant bass test.');
      statusEl.innerHTML = 'Status: Loaded! Click Demo Song ‚Üí Instant vibes.';
    }

    function draw() {
      background(0, 0, 0, 0.08);

      let bass = 0;
      if (fft) {
        bass = fft.getEnergy("bass") / 255 * 2;  // SUPER sensitive
        bass = constrain(bass, 0, 1);
      }

      let dt = 1/60;
      for (let drone of drones) {
        drone.update(dt, bass);
        drone.draw();
      }

      fill(255);
      textSize(36);
      textAlign(LEFT);
      text(`Bass: ${int(bass*100)}% | Thrust: ${int(avgThrust())} | Drones: ${numDrones}`, 20, 60);
    }

    function avgThrust() {
      return drones.reduce((sum, d) => sum + Math.abs(d.thrust), 0) / drones.length;
    }

    function toggleMic() {
      getAudioContext().resume();
      if (!isMicOn) {
        mic = new p5.AudioIn();
        mic.start().then(() => {
          fft = new p5.FFT(0.9, 2048);
          fft.setInput(mic);
          isMicOn = true;
          statusEl.innerHTML = 'Mic ON ‚Äì Clap loud for bass explosion!';
          console.log('Mic LIVE!');
        }).catch(e => statusEl.innerHTML = 'Mic denied ‚Äì Browser settings.');
      } else {
        mic.stop();
        isMicOn = false;
        statusEl.innerHTML = 'Mic OFF';
      }
    }

    // DEMO SONG (Public free beat ‚Äì Instant!)
    function loadDemoSong() {
      statusEl.innerHTML = 'Loading demo bass drop...';
      song = loadSound('https://www.soundjay.com/misc/sounds/bell-ringing-05.wav', () => {
        song.loop();
        fft = new p5.FFT();
        fft.setInput(song);
        statusEl.innerHTML = 'Demo ON ‚Äì Bass dropping! Upload your own next.';
        console.log('Demo playing!');
      });
    }

    // UPLOAD (No collision, direct label trigger)
    function handleSong(event) {
      const file = event.target.files[0];
      if (file) {
        statusEl.innerHTML = `Uploading "${file.name}"...`;
        console.log('Upload:', file.name);
        if (song) song.stop();
        song = loadSound(URL.createObjectURL(file), () => {
          song.loop();  // Loop for endless vibes
          fft = new p5.FFT(0.9, 2048);
          fft.setInput(song);
          statusEl.innerHTML = `"${file.name}" LOADED & PLAYING! Bass live.`;
          console.log('Song LOADED & LOOPING!');
        }, () => statusEl.innerHTML = 'Load fail ‚Äì Try smaller MP3.');
      }
    }

    function windowResized() {
      resizeCanvas(windowWidth, windowHeight);
    }
  </script>
</body>
</html>
