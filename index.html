<!DOCTYPE html>
<html>
<head>
  <title>VibeFlight: Music-Reactive Drone Swarm üöÄ‚ú®</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.4/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.4/addons/p5.sound.min.js"></script>
  <style>
    html, body { margin:0; padding:0; overflow:hidden; background: #000; font-family: monospace; color: #0ff; }
    canvas { display: block; }
    #info { position: absolute; top:10px; left:10px; z-index:10; background:rgba(0,0,0,0.7); padding:15px; border-radius:10px; max-width:400px; }
    button { background: linear-gradient(45deg, #f0f, #ff0); color:#000; border:none; padding:12px 20px; cursor:pointer; font-size:16px; border-radius:8px; margin:5px 0; display:block; width:100%; box-sizing:border-box; font-weight:bold; }
    button:hover { background: linear-gradient(45deg, #ff0, #f0f); transform: scale(1.05); }
    #status { color: #0f0; font-size:14px; margin-top:10px; font-family: monospace; }
    #playBtn { background: linear-gradient(45deg, #0f0, #0ff) !important; }
  </style>
</head>
<body>
  <div id="info">
    <h2>VibeFlight by C0DEXog</h2>
    <p>Click below ‚Üí Drones swarm to beats! PID flight sim for LAT Aerospace.</p>
    <button onclick="toggleMic()">üé§ Toggle Mic (Speak/Clap Loud!)</button>
    <button id="songBtn" onclick="loadSong()">üéµ Upload & Play Song (MP3/WAV/OGG)</button>
    <button id="playBtn" onclick="playSong()" style="display:none;">‚ñ∂Ô∏è Play Current Song</button>
    <div id="status">Status: Ready! Console (F12) for logs. Drones vibe ambiently.</div>
    <p><a href="https://github.com/C0DEXog/VibeFlight" target="_blank" style="color:#ff0;">‚≠ê Star on GitHub!</a></p>
  </div>

  <script>
    let mic, fft, song, soundFile;
    let drones = [];
    let numDrones = 30;
    let isMicOn = false;
    let statusEl = document.getElementById('status');
    let playBtn = document.getElementById('playBtn');
    let songBtn = document.getElementById('songBtn');

    // PID Class (unchanged)
    class PID {
      constructor(kp=1.5, ki=0.2, kd=0.2) {
        this.kp = kp; this.ki = ki; this.kd = kd;
        this.prevError = 0; this.integral = 0;
      }
      update(target, current, dt) {
        let error = target - current;
        this.integral += error * dt;
        let derivative = (error - this.prevError) / dt;
        this.prevError = error;
        return this.kp * error + this.ki * this.integral + this.kd * derivative;
      }
    }

    // Drone Class (enhanced bass reaction)
    class Drone {
      constructor(x, y) {
        this.pos = createVector(x, y);
        this.vel = createVector(random(-2,2), random(-2,2));
        this.acc = createVector(0, 0);
        this.angle = 0;
        this.thrust = 0;
        this.trail = [];
        this.pid = new PID();
        this.targetX = x;
        this.targetY = y;
      }
      update(dt, bass) {
        // Stronger music swarm + ambient spin
        this.targetX += sin(frameCount * 0.02 + bass * 8) * 20;
        this.targetY += cos(frameCount * 0.015 + bass * 5) * 20;

        let errorX = this.targetX - this.pos.x;
        this.thrust = this.pid.update(this.targetX, this.pos.x, dt);
        this.thrust = constrain(this.thrust, -10, 10);

        let force = p5.Vector.fromAngle(this.angle + bass * 0.8 + frameCount * 0.01);
        force.mult(this.thrust * 0.02 + bass * 2);
        this.acc = force;
        this.vel.add(this.acc);
        this.vel.mult(0.9);
        this.pos.add(this.vel);

        this.pos.x = constrain(this.pos.x, 0, width);
        this.pos.y = constrain(this.pos.y, 0, height);

        this.trail.push(this.pos.copy());
        if (this.trail.length > 25) this.trail.shift();
      }
      draw() {
        // Epic trails + glow
        drawingContext.shadowBlur = 30;
        drawingContext.shadowColor = `hsl(${frameCount*0.4 % 360}, 100%, 60%)`;
        noFill();
        stroke(0, 255 - bass*50, 255, 120);
        strokeWeight(4);
        beginShape();
        for (let p of this.trail) vertex(p.x, p.y);
        endShape();

        drawingContext.shadowBlur = 25;
        drawingContext.shadowColor = `hsl(${frameCount*0.5 % 360}, 100%, 50%)`;
        fill(255, 200 + abs(this.thrust)*40, 50, 220);
        noStroke();
        ellipse(this.pos.x, this.pos.y, 30 + abs(this.thrust)*1.5, 30 + abs(this.thrust)*1.5);

        fill(0, 255, 0);
        textSize(14);
        textAlign(CENTER);
        text(`${int(this.thrust*10)}`, this.pos.x, this.pos.y + 6);
      }
    }

    function setup() {
      createCanvas(windowWidth, windowHeight);
      colorMode(HSB, 360, 100, 100, 1);

      // Spawn drones
      for (let i = 0; i < numDrones; i++) {
        drones.push(new Drone(random(width*0.1, width*0.9), random(height*0.1, height*0.9)));
      }
      console.log('üåü VibeFlight LOADED! Ambient drones spinning. Click buttons!');
      statusEl.innerHTML = 'Status: Loaded! Ambient vibes ON. Upload song or mic.';
    }

    function draw() {
      background(0, 0, 0, 0.1);  // Smoother trails

      let bass = 0;
      if (fft) {
        bass = fft.getEnergy("bass") / 255 * 1.5;  // Boost sensitivity
        bass = constrain(bass, 0, 1);
      }

      let dt = 1/60;
      for (let drone of drones) {
        drone.update(dt, bass);
        drone.draw();
      }

      // HUD
      fill(255);
      noStroke();
      textSize(32);
      textAlign(LEFT);
      text(`Bass: ${int(bass*100)}% | Avg Thrust: ${int(avgThrust())} | Drones: ${numDrones}`, 20, 50);
    }

    function avgThrust() {
      if (drones.length === 0) return 0;
      return drones.reduce((sum, d) => sum + Math.abs(d.thrust), 0) / drones.length;
    }

    // MIC (improved)
    function toggleMic() {
      getAudioContext().resume();
      if (!isMicOn) {
        mic = new p5.AudioIn();
        mic.start().then(() => {
          fft = new p5.FFT(0.8, 2048);  // Higher res
          fft.setInput(mic);
          isMicOn = true;
          console.log('üé§ MIC LIVE ‚Äì Clap/Rap/Yell!');
          statusEl.innerHTML = 'Status: Mic ON ‚Äì Bass reacting! Speak loud.';
        }).catch(e => {
          console.error('Mic fail:', e);
          statusEl.innerHTML = 'Mic denied. Check site settings > Microphone.';
        });
      } else {
        if (mic) mic.stop();
        isMicOn = false;
        statusEl.innerHTML = 'Status: Mic OFF';
        console.log('Mic stopped');
      }
    }

    // SONG UPLOAD ‚Äì p5.js NATIVE (ZERO GLITCHES)
    function loadSong() {
      console.log('üéµ File picker opening...');
      let input = createFileInput(handleSong);
      input.size(200, 50);  // Styled auto
      input.position(20, 220);  // No overlap
    }

    function handleSong(file) {
      if (file.type === 'audio') {
        console.log('Loading song:', file.name, file.type);
        statusEl.innerHTML = `Loading "${file.name}"...`;

        // p5.SoundFile for local files ‚Äì PERFECT
        soundFile = new p5.SoundFile();
        soundFile.path = URL.createObjectURL(file.data);
        soundFile.loadMetadata(handleSoundReady);
      } else {
        statusEl.innerHTML = 'Invalid: MP3/WAV/OGG only.';
      }
    }

    function handleSoundReady() {
      soundFile.playMode('restart');
      fft = new p5.FFT(0.8, 2048);
      fft.setInput(soundFile);
      playBtn.style.display = 'block';
      songBtn.style.display = 'none';
      statusEl.innerHTML = `Song "${soundFile.name}" READY! Click ‚ñ∂Ô∏è Play.`;
      console.log('Song READY ‚Äì Click play!');
    }

    function playSong() {
      if (soundFile && !soundFile.isPlaying()) {
        soundFile.play();
        console.log('‚ñ∂Ô∏è Song PLAYING ‚Äì Bass incoming!');
        statusEl.innerHTML = `Song PLAYING | Bass live!`;
      }
    }

    function windowResized() {
      resizeCanvas(windowWidth, windowHeight);
    }
  </script>
</body>
</html>
